rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for common checks
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() 
        && (request.auth.token.admin == true 
            || request.auth.token.role == 'admin' 
            || request.auth.token.role == 'superadmin');
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isOwnerOrAdmin(userId) {
      return isOwner(userId) || isAdmin();
    }
    
    function hasValidFields(required, optional) {
      let allFields = required.concat(optional);
      let incomingFields = request.resource.data.keys();
      let hasAllRequired = required.toSet().difference(incomingFields.toSet()).size() == 0;
      let hasOnlyAllowed = incomingFields.toSet().difference(allFields.toSet()).size() == 0;
      return hasAllRequired && hasOnlyAllowed;
    }
    
    function isValidString(field, minLen, maxLen) {
      return request.resource.data[field] is string
        && request.resource.data[field].size() >= minLen
        && request.resource.data[field].size() <= maxLen;
    }
    
    function isValidNumber(field, min, max) {
      return request.resource.data[field] is number
        && request.resource.data[field] >= min
        && request.resource.data[field] <= max;
    }
    
    function isValidTimestamp(field) {
      return request.resource.data[field] is timestamp;
    }
    
    // Products collection rules - SECURE: Owner verification required
    match /products/{productId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated()
        && request.resource.data.creatorId == request.auth.uid
        && request.resource.data.keys().hasAll(['creatorId', 'name', 'price', 'category', 'createdAt'])
        && request.resource.data.creatorId is string
        && request.resource.data.name is string
        && request.resource.data.price is number
        && request.resource.data.category is string
        && request.resource.data.createdAt is timestamp;
      
      allow update: if isAuthenticated()
        && (isOwner(resource.data.creatorId) || isAdmin())
        && request.resource.data.creatorId == resource.data.creatorId;
      
      allow delete: if isAuthenticated()
        && (isOwner(resource.data.creatorId) || isAdmin());
    }
    
    // Categories collection rules
    match /categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // User profiles collection rules
    match /users/{userId} {
      allow read: if isOwnerOrAdmin(userId);
      
      allow create: if isOwner(userId)
        && hasValidFields(
          ['id', 'email', 'displayName', 'createdAt'],
          ['username', 'profileImageUrl', 'bio', 'updatedAt', 'preferences', 'metadata']
        )
        && isValidString('email', 5, 100)
        && isValidString('displayName', 2, 50)
        && isValidTimestamp('createdAt');
      
      allow update: if isOwner(userId)
        && request.resource.data.id == resource.data.id  // Can't change user ID
        && request.resource.data.email == resource.data.email  // Can't change email
        && isValidTimestamp('updatedAt');
      
      allow delete: if isOwner(userId);
    }
    
    // Orders collection rules - SECURE: Owner and admin access only
    match /orders/{orderId} {
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && hasValidFields(
          ['userId', 'items', 'total', 'status', 'createdAt'],
          ['shippingAddress', 'paymentMethod', 'updatedAt', 'metadata']
        )
        && isValidTimestamp('createdAt');
      
      allow read: if isAuthenticated() 
        && (resource.data.userId == request.auth.uid || isAdmin());
      
      allow update: if isAuthenticated() 
        && (resource.data.userId == request.auth.uid || isAdmin())
        && request.resource.data.userId == resource.data.userId;
      
      allow delete: if isAdmin(); // Only admins can delete orders
    }
    
    // Reviews collection rules - SECURE: Owner verification and comment validation
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated()
        && isOwner(request.resource.data.userId)
        && hasValidFields(
          ['userId', 'productId', 'rating', 'createdAt'],
          ['comment', 'updatedAt', 'metadata']
        )
        && isValidNumber('rating', 1, 5)
        && isValidTimestamp('createdAt')
        && (request.resource.data.comment == null 
            || (request.resource.data.comment is string 
                && request.resource.data.comment.size() <= 1000));  // Limit comment length
      
      allow update: if isOwnerOrAdmin(resource.data.userId)
        && request.resource.data.userId == resource.data.userId
        && (request.resource.data.comment == null 
            || (request.resource.data.comment is string 
                && request.resource.data.comment.size() <= 1000));
      
      allow delete: if isOwnerOrAdmin(resource.data.userId);
    }
    
    // Stickers collection rules - SECURE: Owner verification required
    match /stickers/{stickerId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated()
        && request.resource.data.creatorId == request.auth.uid
        && request.resource.data.creatorId is string
        && request.resource.data.name is string
        && request.resource.data.price is number
        && request.resource.data.category is string
        && request.resource.data.imageUrls is list
        && request.resource.data.status is string
        && request.resource.data.createdAt is timestamp;
      
      allow update: if isAuthenticated()
        && (isOwner(resource.data.creatorId) || isAdmin())
        && request.resource.data.creatorId == resource.data.creatorId;
      
      allow delete: if isAuthenticated()
        && (isOwner(resource.data.creatorId) || isAdmin());
    }
    
    // User likes collection rules - SECURE: Owner verification required
    match /user_likes/{likeId} {
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) 
            || (likeId.matches('.*_.*') && likeId.split('_')[0] == request.auth.uid));
      
      allow create: if isAuthenticated()
        && isOwner(request.resource.data.userId)  // Must be the owner of the like
        && request.resource.data.userId == request.auth.uid  // Double-check ownership
        && hasValidFields(['userId', 'productId', 'createdAt'], ['metadata'])
        && request.resource.data.productId is string
        && request.resource.data.productId.size() > 0;
      
      allow delete: if isAuthenticated()
        && isOwner(resource.data.userId);  // Only owner can delete
      
      allow update: if false;  // No updates allowed
    }
    
    // System settings collection rules (admin only)
    match /system_settings/{document} {
      allow read, write: if isAdmin();
    }
    
    // Audit logs collection rules (admin only)
    match /audit_logs/{document} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Admin audit logs collection rules (admin only) - legacy support
    match /admin_audit_logs/{document} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Sticker revenue collection rules - SECURE: Admin-only write, owner/admin read
    match /sticker_revenue/{revenueId} {
      allow read: if isAuthenticated() 
        && (resource.data.creatorId == request.auth.uid || isAdmin());
      
      allow create: if isAdmin(); // Only system/admins can create revenue records
      
      allow update, delete: if isAdmin(); // Only admins can modify revenue
    }
    
    // Creator earnings collection rules - SECURE: Admin-only write, owner/admin read
    match /creator_earnings/{earningsId} {
      allow read: if isAuthenticated() 
        && (resource.data.creatorId == request.auth.uid || isAdmin());
      
      allow create: if isAdmin(); // Only system/admins can create earnings
      
      allow update, delete: if isAdmin(); // Only admins can modify earnings
    }
    
    // Creator payout settings collection rules
    match /creator_payout_settings/{settingsId} {
      allow read: if isOwner(resource.data.creatorId) || isAdmin();
      
      allow create: if isAuthenticated()
        && isOwner(request.resource.data.creatorId)
        && hasValidFields(
          ['creatorId', 'paymentMethod', 'createdAt'],
          ['accountDetails', 'updatedAt', 'metadata']
        );
      
      allow update: if isOwner(resource.data.creatorId)
        && request.resource.data.creatorId == resource.data.creatorId;
      
      allow delete: if isAdmin();
    }
    
    // Payout requests collection rules
    match /payout_requests/{requestId} {
      allow read: if isOwner(resource.data.creatorId) || isAdmin();
      
      allow create: if isAuthenticated()
        && isOwner(request.resource.data.creatorId)
        && hasValidFields(
          ['creatorId', 'amount', 'status', 'createdAt'],
          ['paymentMethod', 'updatedAt', 'metadata']
        )
        && isValidNumber('amount', 0, 10000000)
        && request.resource.data.status == 'pending';
      
      allow update: if (isOwner(resource.data.creatorId) 
                       && resource.data.status == 'pending')
                     || isAdmin();
      
      allow delete: if isAdmin();
    }
    
    // Cart collection rules (if using Firestore for cart)
    match /carts/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
    
    match /cart_items/{cartItemId} {
      allow read: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && hasValidFields(
          ['userId', 'productId', 'quantity', 'createdAt'],
          ['updatedAt', 'metadata']
        );
      
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;
      
      allow delete: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
    }

    // Newsletter signups - public create with validation, public read for existence check, admin-only list
    // SECURITY: Rate limiting should be implemented at application level
    // Users can check if their own email exists (document ID is normalized email)
    match /newsletter_signups/{signupId} {
      // Allow public users to read specific documents (to check if email exists)
      // They can only read by document ID (normalized email), not list all documents
      allow read: if true;
      // Admin-only for listing all signups (handled by admin query permissions)
      
      allow create: if hasValidFields(['email', 'createdAt'], ['source', 'normalizedEmail'])
        && request.resource.data.email is string
        && request.resource.data.email.size() >= 5
        && request.resource.data.email.size() <= 100
        && request.resource.data.email.matches('^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$')  // Email format validation
        && request.resource.data.createdAt is timestamp
        && (request.resource.data.source == null || request.resource.data.source is string)
        && (request.resource.data.source == null || request.resource.data.source.size() <= 50)
        && (request.resource.data.normalizedEmail == null || request.resource.data.normalizedEmail is string);
      
      allow update, delete: if false;  // No updates or deletes allowed
    }
    
    // Default deny rule for any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

