rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for common checks
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() 
        && (request.auth.token.admin == true 
            || request.auth.token.role == 'admin' 
            || request.auth.token.role == 'superadmin');
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isOwnerOrAdmin(userId) {
      return isOwner(userId) || isAdmin();
    }
    
    function hasValidFields(required, optional) {
      let allFields = required.concat(optional);
      let incomingFields = request.resource.data.keys();
      let hasAllRequired = required.toSet().difference(incomingFields.toSet()).size() == 0;
      let hasOnlyAllowed = incomingFields.toSet().difference(allFields.toSet()).size() == 0;
      return hasAllRequired && hasOnlyAllowed;
    }
    
    function isValidString(field, minLen, maxLen) {
      return request.resource.data[field] is string
        && request.resource.data[field].size() >= minLen
        && request.resource.data[field].size() <= maxLen;
    }
    
    function isValidNumber(field, min, max) {
      return request.resource.data[field] is number
        && request.resource.data[field] >= min
        && request.resource.data[field] <= max;
    }
    
    function isValidTimestamp(field) {
      return request.resource.data[field] is timestamp;
    }
    
    // Products collection rules - RELAXED FOR DEBUGGING
    match /products/{productId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['creatorId', 'name', 'price', 'category', 'createdAt'])
        && request.resource.data.creatorId is string
        && request.resource.data.name is string
        && request.resource.data.price is number
        && request.resource.data.category is string
        && request.resource.data.createdAt is timestamp;
      
      allow update: if isAuthenticated()
        && (isOwner(resource.data.creatorId) || isAdmin())
        && request.resource.data.creatorId == resource.data.creatorId;
      
      allow delete: if isAuthenticated()
        && (isOwner(resource.data.creatorId) || isAdmin());
    }
    
    // Categories collection rules
    match /categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // User profiles collection rules
    match /users/{userId} {
      allow read: if isOwnerOrAdmin(userId);
      
      allow create: if isOwner(userId)
        && hasValidFields(
          ['id', 'email', 'displayName', 'createdAt'],
          ['username', 'profileImageUrl', 'bio', 'updatedAt', 'preferences', 'metadata']
        )
        && isValidString('email', 5, 100)
        && isValidString('displayName', 2, 50)
        && isValidTimestamp('createdAt');
      
      allow update: if isOwner(userId)
        && request.resource.data.id == resource.data.id  // Can't change user ID
        && request.resource.data.email == resource.data.email  // Can't change email
        && isValidTimestamp('updatedAt');
      
      allow delete: if isOwner(userId);
    }
    
    // Orders collection rules - VERY RELAXED FOR DEBUGGING
    match /orders/{orderId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if isAuthenticated();
    }
    
    // Reviews collection rules
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated()
        && isOwner(request.resource.data.userId)
        && hasValidFields(
          ['userId', 'productId', 'rating', 'createdAt'],
          ['comment', 'updatedAt', 'metadata']
        )
        && isValidNumber('rating', 1, 5)
        && isValidTimestamp('createdAt');
      
      allow update, delete: if isOwnerOrAdmin(resource.data.userId);
    }
    
    // Stickers collection rules - RELAXED FOR COMPATIBILITY WITH StickerEntity
    match /stickers/{stickerId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated()
        && request.resource.data.creatorId is string
        && request.resource.data.name is string
        && request.resource.data.price is number
        && request.resource.data.category is string
        && request.resource.data.imageUrls is list
        && request.resource.data.status is string
        && request.resource.data.createdAt is timestamp;
      
      allow update: if isAuthenticated()
        && (isOwner(resource.data.creatorId) || isAdmin())
        && request.resource.data.creatorId == resource.data.creatorId;
      
      allow delete: if isAuthenticated()
        && (isOwner(resource.data.creatorId) || isAdmin());
    }
    
    // User likes collection rules
    match /user_likes/{likeId} {
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) 
            || likeId.split('_')[0] == request.auth.uid);
      
      allow create: if isAuthenticated()
        && (isOwner(request.resource.data.userId) 
            || likeId.split('_')[0] == request.auth.uid)
        && hasValidFields(['userId', 'productId', 'createdAt'], ['metadata']);
      
      allow delete: if isAuthenticated()
        && (isOwner(resource.data.userId) 
            || likeId.split('_')[0] == request.auth.uid);
    }
    
    // System settings collection rules (admin only)
    match /system_settings/{document} {
      allow read, write: if isAdmin();
    }
    
    // Admin audit logs collection rules (admin only, append-only)
    match /admin_audit_logs/{document} {
      allow read: if isAdmin();
      allow create: if isAdmin();  // Append-only for accountability
    }
    
    // Sticker revenue collection rules - RELAXED FOR DEBUGGING
    match /sticker_revenue/{revenueId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Creator earnings collection rules - RELAXED FOR DEBUGGING
    match /creator_earnings/{earningsId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Creator payout settings collection rules
    match /creator_payout_settings/{settingsId} {
      allow read: if isOwner(resource.data.creatorId) || isAdmin();
      
      allow create: if isAuthenticated()
        && isOwner(request.resource.data.creatorId)
        && hasValidFields(
          ['creatorId', 'paymentMethod', 'createdAt'],
          ['accountDetails', 'updatedAt', 'metadata']
        );
      
      allow update: if isOwner(resource.data.creatorId)
        && request.resource.data.creatorId == resource.data.creatorId;
      
      allow delete: if isAdmin();
    }
    
    // Payout requests collection rules
    match /payout_requests/{requestId} {
      allow read: if isOwner(resource.data.creatorId) || isAdmin();
      
      allow create: if isAuthenticated()
        && isOwner(request.resource.data.creatorId)
        && hasValidFields(
          ['creatorId', 'amount', 'status', 'createdAt'],
          ['paymentMethod', 'updatedAt', 'metadata']
        )
        && isValidNumber('amount', 0, 10000000)
        && request.resource.data.status == 'pending';
      
      allow update: if (isOwner(resource.data.creatorId) 
                       && resource.data.status == 'pending')
                     || isAdmin();
      
      allow delete: if isAdmin();
    }
    
    // Cart collection rules (if using Firestore for cart)
    match /carts/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
    
    match /cart_items/{cartItemId} {
      allow read, write: if isAuthenticated();
    }

    match /newsletter_signups/{signupId} {
      allow read: if isAdmin();
      allow create: if hasValidFields(['email', 'createdAt'], ['source'])
        && request.resource.data.email is string
        && request.resource.data.email.size() >= 5
        && request.resource.data.email.size() <= 100
        && request.resource.data.createdAt is timestamp
        && (request.resource.data.source == null || request.resource.data.source is string);
    }
    
    // Default deny rule for any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

